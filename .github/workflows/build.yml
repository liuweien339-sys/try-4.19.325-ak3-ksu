name: ä¸ºå°ç±³Note10 Liteç¼–è¯‘å†…æ ¸+SukiSU-Ultra

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build_kernel:
    name: ç¼–è¯‘4.19å†…æ ¸é›†æˆSukiSU
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€å‡ºä»“åº“ï¼ˆåŒ…å«å®Œæ•´.configå’ŒAnyKernel3ï¼‰
        uses: actions/checkout@v4

      - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y git ccache flex bison build-essential libssl-dev \
            libncurses-dev xz-utils zstd libelf-dev bc cpio python3 \
            gcc-aarch64-linux-gnu llvm-ar llvm-objdump llvm-dev llvm-runtime llvm-tools llvn-nm

      - name: å¯ç”¨ccacheåŠ é€Ÿ
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: gauguin-${{ github.sha }}
          max-size: 5G

      - name: å…‹éš†gauguinå†…æ ¸æºç 
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin.git -b lineage-23.2 kernel
          cd kernel

      - name: é›†æˆSukiSU-Ultraï¼ˆéGKIæ‰‹åŠ¨é€‚é…ï¼‰
        run: |
          cd kernel
          
          # 1. å…‹éš†SukiSU-Ultraå®˜æ–¹ä»“åº“
          echo "æ­£åœ¨å…‹éš†SukiSU-Ultra..."
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU-Ultra.git
          
          # 2. åˆ›å»ºè½¯é“¾æ¥
          echo "åˆ›å»ºKernelSUè½¯é“¾æ¥..."
          ln -sf SukiSU-Ultra/kernel KernelSU
          
          # 3. éGKIæ‰‹åŠ¨è¡¥ä¸
          echo "æ­£åœ¨ä¸ºéGKIå†…æ ¸æ‰“è¡¥ä¸..."
          
          # drivers/Makefile
          if ! grep -q "KernelSU" drivers/Makefile; then
            echo "obj-y += KernelSU/" >> drivers/Makefile
          fi
          
          # åˆ›å»ºé©±åŠ¨é“¾æ¥
          if [ ! -d "drivers/KernelSU" ]; then
            ln -sf ../KernelSU drivers/KernelSU
          fi
          
          # fs/exec.c
          sed -i 's/#include <linux\/binfmts.h>/#include <linux\/binfmts.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/exec.c
          if ! grep -q "ksu_handle_execve" fs/exec.c; then
            sed -i '/return 0;/i \ \ if (unlikely(current->mm->ksu_execve_count))\
            \ \ \ \ ksu_handle_execve(current->mm->exe_file);' fs/exec.c
          fi
          
          # fs/open.c
          sed -i 's/#include <linux\/audit.h>/#include <linux\/audit.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/open.c
          if ! grep -q "ksu_handle_faccessat" fs/open.c; then
            sed -i '/if (error)/i \ \ ksu_handle_faccessat(&dfd, filename, &mode);' fs/open.c
          fi
          
          # fs/read_write.c
          sed -i 's/#include <linux\/fs.h>/#include <linux\/fs.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/read_write.c
          if ! grep -q "ksu_handle_vfs_read" fs/read_write.c; then
            sed -i '/if (file->f_op->read)/i \ \ ksu_handle_vfs_read(file, buf, count, pos);' fs/read_write.c
          fi
          
          # fs/stat.c
          sed -i 's/#include <linux\/mnt_idmapping.h>/#include <linux\/mnt_idmapping.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/stat.c
          
          # 4. éªŒè¯é›†æˆ
          echo "éªŒè¯é›†æˆç»“æœï¼š"
          ls -la KernelSU/ | grep -E "ksu\.c|ksu\.h"
          echo "âœ… SukiSU-Ultraé›†æˆå®Œæˆ"

      - name: åº”ç”¨ä½ çš„å®Œæ•´.config
        run: |
          cd kernel
          
          # ğŸ”¥ ç›´æ¥ä»ä½ çš„ä»“åº“å¤åˆ¶å®Œæ•´çš„.config
          echo "ä½¿ç”¨ä»“åº“ä¸­çš„å®Œæ•´.config..."
          cp ../kernel_source/.config .config
          
          # ç¡®ä¿.configæ˜¯æœ€æ–°çš„
          make ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 olddefconfig
          
          # éªŒè¯KSUæ˜¯å¦å¼€å¯
          echo "éªŒè¯KSUé…ç½®çŠ¶æ€ï¼š"
          grep CONFIG_KSU .config || echo "âš ï¸ è­¦å‘Šï¼šCONFIG_KSUæœªå¼€å¯"
          grep CONFIG_KALLSYMS .config || echo "âš ï¸ è­¦å‘Šï¼šCONFIG_KALLSYMSæœªå¼€å¯"

      - name: ç¼–è¯‘å†…æ ¸é•œåƒ
        run: |
          cd kernel
          export PATH=/usr/lib/ccache:$PATH
          
          echo "å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼Œçº¦40-60åˆ†é’Ÿ..."
          make -i -k -j$(nproc) ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 Image.gz dtbs 2>&1 | tee build.log
          
          if [ -f "arch/arm64/boot/Image.gz" ]; then
            echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸ"
            ls -lh arch/arm64/boot/Image.gz
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: æ‰“åŒ…AnyKernel3
        run: |
          # ä½¿ç”¨ä½ ä»“åº“é‡Œçš„AnyKernel3
          if [ ! -d "AnyKernel3" ]; then
            echo "âŒ æœªæ‰¾åˆ°AnyKernel3ç›®å½•"
            exit 1
          fi
          
          cp kernel/arch/arm64/boot/Image.gz AnyKernel3/
          
          # DTBå¤„ç†
          if [ -f kernel/arch/arm64/boot/dtb.img ]; then
            cp kernel/arch/arm64/boot/dtb.img AnyKernel3/
          elif [ -d kernel/arch/arm64/boot/dts ]; then
            find kernel/arch/arm64/boot/dts -name "*.dtb" -exec cat {} + > AnyKernel3/dtb
          fi
          
          cd AnyKernel3
          zip -r9 ../gauguin-SukiSU-$(date +%Y%m%d-%H%M).zip *
          cd ..
          
          echo "âœ… åˆ·æœºåŒ…æ‰“åŒ…å®Œæˆ"

      - name: ä¸Šä¼ åˆ·æœºåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: gauguin-kernel-sukisu
          path: gauguin-SukiSU-*.zip

      - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: kernel/build.log
