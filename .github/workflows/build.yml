name: ä¸ºå°ç±³Note10 Liteç¼–è¯‘å†…æ ¸+SukiSU-Ultraï¼ˆClang 21.0.0ç‰ˆï¼‰

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build_kernel:
    name: ç¼–è¯‘4.19å†…æ ¸é›†æˆSukiSU
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€å‡ºä»“åº“ï¼ˆåŒ…å«å®Œæ•´.configå’ŒAnyKernel3ï¼‰
        uses: actions/checkout@v4

      - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y \
            git ccache flex bison build-essential libssl-dev \
            libncurses-dev xz-utils zstd libelf-dev bc cpio python3 \
            binutils-aarch64-linux-gnu
          
          # ğŸ”¥ğŸ”¥ğŸ”¥ ä¸‹è½½Clang 21.0.0ï¼ˆå’Œä½ æ‰‹æœºå®Œå…¨ä¸€è‡´ï¼‰ ğŸ”¥ğŸ”¥ğŸ”¥
          mkdir -p /tmp/clang
          cd /tmp/clang
          
          # ä»Androidå®˜æ–¹ä»“åº“ä¸‹è½½Clang 21.0.0 (r563880c)
          wget https://gitlab.com/reaPeR1010/android_prebuilts_clang_host_linux-x86_clang-r563880/-/archive/master/android_prebuilts_clang_host_linux-x86_clang-r563880-master.tar.gz
          tar -xzf android_prebuilts_clang_host_linux-x86_clang-r563880-master.tar.gz
          
          # å®‰è£…åˆ°ç³»ç»Ÿç›®å½•
          sudo mkdir -p /usr/lib/clang-21
          sudo cp -r * /usr/lib/clang-21/
          
          # åˆ›å»ºè½¯é“¾æ¥ï¼ˆå¸¦ç‰ˆæœ¬å·å’Œä¸å¸¦ç‰ˆæœ¬å·çš„éƒ½å»ºç«‹ï¼‰
          sudo ln -sf /usr/lib/clang-21/bin/clang /usr/bin/clang-21
          sudo ln -sf /usr/lib/clang-21/bin/clang++ /usr/bin/clang++-21
          sudo ln -sf /usr/lib/clang-21/bin/clang /usr/bin/clang
          sudo ln -sf /usr/lib/clang-21/bin/clang++ /usr/bin/clang++
          
          # LLVMå·¥å…·é“¾
          for tool in ar objdump objcopy strip nm readelf; do
            sudo ln -sf /usr/lib/clang-21/bin/llvm-$tool /usr/bin/llvm-$tool-21
            sudo ln -sf /usr/lib/clang-21/bin/llvm-$tool /usr/bin/llvm-$tool
          done
          
          # éªŒè¯ç‰ˆæœ¬
          echo "âœ… Clangç‰ˆæœ¬ï¼š"
          clang --version | head -n3
          echo "âœ… LLVMç‰ˆæœ¬ï¼š"
          llvm-objdump --version | head -n1

      - name: å¯ç”¨ccacheåŠ é€Ÿ
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: gauguin-clang21-${{ github.sha }}
          max-size: 5G

      - name: å…‹éš†gauguinå†…æ ¸æºç 
        run: |
          git clone --depth=1 https://github.com/LineageOS/android_kernel_xiaomi_gauguin.git -b lineage-23.2 kernel
          cd kernel

      - name: é›†æˆSukiSU-Ultraï¼ˆéGKIæ‰‹åŠ¨é€‚é…ï¼‰
        run: |
          cd kernel
          
          echo "æ­£åœ¨å…‹éš†SukiSU-Ultra..."
          git clone --depth=1 https://github.com/SukiSU-Ultra/SukiSU-Ultra.git
          
          echo "åˆ›å»ºKernelSUè½¯é“¾æ¥..."
          ln -sf SukiSU-Ultra/kernel KernelSU
          
          echo "æ­£åœ¨ä¸ºéGKIå†…æ ¸æ‰“è¡¥ä¸..."
          
          # drivers/Makefile
          if ! grep -q "KernelSU" drivers/Makefile; then
            echo "obj-y += KernelSU/" >> drivers/Makefile
          fi
          
          # åˆ›å»ºé©±åŠ¨é“¾æ¥
          if [ ! -d "drivers/KernelSU" ]; then
            ln -sf ../KernelSU drivers/KernelSU
          fi
          
          # fs/exec.c
          sed -i 's/#include <linux\/binfmts.h>/#include <linux\/binfmts.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/exec.c
          if ! grep -q "ksu_handle_execve" fs/exec.c; then
            sed -i '/return 0;/i \ \ if (unlikely(current->mm->ksu_execve_count))\
            \ \ \ \ ksu_handle_execve(current->mm->exe_file);' fs/exec.c
          fi
          
          # fs/open.c
          sed -i 's/#include <linux\/audit.h>/#include <linux\/audit.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/open.c
          if ! grep -q "ksu_handle_faccessat" fs/open.c; then
            sed -i '/if (error)/i \ \ ksu_handle_faccessat(&dfd, filename, &mode);' fs/open.c
          fi
          
          # fs/read_write.c
          sed -i 's/#include <linux\/fs.h>/#include <linux\/fs.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/read_write.c
          if ! grep -q "ksu_handle_vfs_read" fs/read_write.c; then
            sed -i '/if (file->f_op->read)/i \ \ ksu_handle_vfs_read(file, buf, count, pos);' fs/read_write.c
          fi
          
          # fs/stat.c
          sed -i 's/#include <linux\/mnt_idmapping.h>/#include <linux\/mnt_idmapping.h>\n#include "..\/KernelSU\/ksu.h"/g' fs/stat.c
          
          echo "âœ… SukiSU-Ultraé›†æˆå®Œæˆ"
          ls -la KernelSU/ | grep -E "ksu\.c|ksu\.h"

      - name: åº”ç”¨ä½ çš„å®Œæ•´.config
        run: |
          cd kernel
          cp ../kernel_source/.config .config
          
          # ğŸ”¥ ä½¿ç”¨å’Œä½ æ‰‹æœºå®Œå…¨ä¸€æ ·çš„Clang 21.0.0 ğŸ”¥
          make ARCH=arm64 CC=clang-21 LLVM=1 LLVM_IAS=1 olddefconfig
          
          # éªŒè¯é…ç½®
          echo "KSUé…ç½®çŠ¶æ€ï¼š"
          grep CONFIG_KSU .config || echo "âš ï¸ CONFIG_KSUæœªå¼€å¯"
          grep CONFIG_KALLSYMS .config || echo "âš ï¸ CONFIG_KALLSYMSæœªå¼€å¯"

      - name: ç¼–è¯‘å†…æ ¸é•œåƒ
        run: |
          cd kernel
          export PATH=/usr/lib/ccache:$PATH
          
          echo "ğŸ”¥ ä½¿ç”¨Clang 21.0.0ç¼–è¯‘å†…æ ¸ï¼ˆå’Œä½ æ‰‹æœºå®Œå…¨ä¸€è‡´ï¼‰..."
          
          # ä½¿ç”¨å¸¦ç‰ˆæœ¬å·çš„å·¥å…·ï¼Œç¡®ä¿æ˜¯Clang 21
          make -i -k -j$(nproc) \
            ARCH=arm64 \
            CC=clang-21 \
            AR=llvm-ar-21 \
            NM=llvm-nm-21 \
            OBJCOPY=llvm-objcopy-21 \
            OBJDUMP=llvm-objdump-21 \
            STRIP=llvm-strip-21 \
            READELF=llvm-readelf-21 \
            LLVM=1 \
            LLVM_IAS=1 \
            Image.gz dtbs 2>&1 | tee build.log
          
          # æ£€æŸ¥ç¼–è¯‘äº§ç‰©
          if [ -f "arch/arm64/boot/Image.gz" ]; then
            echo "âœ… å†…æ ¸é•œåƒç”Ÿæˆ"
            ls -lh arch/arm64/boot/Image.gz
            
            # æŸ¥çœ‹ç¼–è¯‘å‡ºçš„å†…æ ¸ç‰ˆæœ¬
            strings arch/arm64/boot/Image.gz | grep "Linux version" || true
          else
            echo "âŒ å†…æ ¸é•œåƒæœªç”Ÿæˆ"
          fi

      - name: æ‰“åŒ…AnyKernel3
        run: |
          if [ ! -d "AnyKernel3" ]; then
            echo "âŒ æœªæ‰¾åˆ°AnyKernel3ç›®å½•"
            exit 1
          fi
          
          if [ -f "kernel/arch/arm64/boot/Image.gz" ]; then
            cp kernel/arch/arm64/boot/Image.gz AnyKernel3/
            
            # DTBå¤„ç†
            if [ -f kernel/arch/arm64/boot/dtb.img ]; then
              cp kernel/arch/arm64/boot/dtb.img AnyKernel3/
            elif [ -d kernel/arch/arm64/boot/dts ]; then
              find kernel/arch/arm64/boot/dts -name "*.dtb" -exec cat {} + > AnyKernel3/dtb
            fi
            
            cd AnyKernel3
            zip -r9 ../gauguin-SukiSU-Clang21-$(date +%Y%m%d-%H%M).zip *
            cd ..
            echo "âœ… åˆ·æœºåŒ…æ‰“åŒ…å®Œæˆ"
          else
            echo "âŒ æ— å†…æ ¸é•œåƒï¼Œä¸æ‰“åŒ…"
          fi

      - name: ä¸Šä¼ åˆ·æœºåŒ…
        uses: actions/upload-artifact@v4
        with:
          name: gauguin-kernel-sukisu-clang21
          path: gauguin-SukiSU-Clang21-*.zip
          if-no-files-found: warn

      - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: build-log-clang21
          path: kernel/build.log
          if-no-files-found: warn
